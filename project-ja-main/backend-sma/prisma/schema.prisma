generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  CUSTOMER
  STORE
  // ✅ เพิ่มสำหรับ Admin
  ADMIN
}

// ✅ เพิ่ม: สถานะบัญชี (ใช้สำหรับ “ระงับ/ปลดระงับ”)
enum UserStatus {
  ACTIVE
  SUSPENDED
}

model User {
  id              Int       @id @default(autoincrement())
  email           String    @unique
  passwordHash    String
  role            Role
  emailVerifiedAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // ✅ เพิ่ม: สถานะ + ข้อมูลระงับ + เวลา login ล่าสุด
  status          UserStatus @default(ACTIVE)
  suspendedAt     DateTime?
  suspendedReason String?
  lastLoginAt     DateTime?

  customerProfile CustomerProfile?
  storeProfile    StoreProfile?

  verificationTokens VerificationToken[]
  resetTokens        PasswordResetToken[]

  // ใบรับประกันที่ "ร้าน" นี้ออก (Header)
  warranties Warranty[]

  // ★ ใบรับประกันที่ "ลูกค้าคนนี้เป็นเจ้าของ"
  customerWarranties Warranty[] @relation("CustomerWarranties")

  // ★ เพิ่ม: ความสัมพันธ์กับ Satisfaction (แก้ปัญหา Ambiguous)
  feedbacksGiven    Satisfaction[] @relation("SatisfactionGiven")    // ฟีดแบ็กที่ User คนนี้เขียน
  feedbacksReceived Satisfaction[] @relation("SatisfactionReceived") // ฟีดแบ็กที่ User คนนี้ได้รับ (ในฐานะร้าน)

  // เพิ่ม: ความสัมพันธ์กับ Notification
  notifications Notification[]

  // ✅ เพิ่ม: สำหรับ Admin (Logs / Security / Complaints)
  auditLogs      AuditLog[]      @relation("AuditLogsActor")
  securityEvents SecurityEvent[] @relation("SecurityEventsUser")
  complaints     Complaint[]     @relation("ComplaintsUser")

  @@index([role])
  @@index([status])
}

model CustomerProfile {
  id        Int     @id @default(autoincrement())
  userId    Int     @unique
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName String
  lastName  String
  phone     String
  isConsent Boolean @default(false)
  avatarUrl String?
}

model StoreProfile {
  id                  Int      @id @default(autoincrement())
  userId              Int      @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  storeName           String
  storeType           String
  ownerName           String
  contactName         String?
  phone               String
  email               String?
  address             String
  businessHours       String
  avatarUrl           String?
  notifyDaysInAdvance Int      @default(14)
  isConsent           Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model VerificationToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  usedAt    DateTime?
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  usedAt    DateTime?
}

model Warranty {
  id      String @id @default(cuid())
  storeId Int
  store   User   @relation(fields: [storeId], references: [id], onDelete: Cascade)

  code          String
  customerEmail String?
  customerName  String?
  customerPhone String?

  // ★ FK ไปยังบัญชีลูกค้า (ถ้าเจออีเมลที่เป็น CUSTOMER)
  customerUserId Int?
  customer       User? @relation("CustomerWarranties", fields: [customerUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items WarrantyItem[]

  /// ทำให้ WR ยูนีค “แยกร้าน”
  @@unique([storeId, code], name: "storeId_code")
  @@index([customerUserId])
}

model WarrantyItem {
  id          String   @id @default(cuid())
  warrantyId  String
  warranty    Warranty @relation(fields: [warrantyId], references: [id], onDelete: Cascade)

  productName    String
  model          String?
  serial         String?
  purchaseDate   DateTime
  expiryDate     DateTime?
  durationMonths Int?
  durationDays   Int?
  coverageNote   String?
  note           String?
  documents      Json?
  images         Json?

  // ★ หมายเหตุโดย "ลูกค้า"
  customerNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// ทำให้ SN ยูนีค “ภายในใบเดียวกัน”
  @@unique([warrantyId, serial], name: "warrantyId_serial")
}

/// เก็บฟีดแบ็กความพึงพอใจจากผู้ใช้
model Satisfaction {
  id      Int     @id @default(autoincrement())
  rating  Int     // 1..5
  comment String?

  userId Int?
  // ★ เติมชื่อ Relation: SatisfactionGiven
  user   User? @relation("SatisfactionGiven", fields: [userId], references: [id], onDelete: SetNull)

  storeId Int?
  // ★ เติมชื่อ Relation: SatisfactionReceived
  store   User? @relation("SatisfactionReceived", fields: [storeId], references: [id], onDelete: SetNull)

  warrantyId String?
  createdAt  DateTime @default(now())
}

model Notification {
  id Int @id @default(autoincrement())

  userId Int?
  user   User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  storeId Int?

  title     String
  body      String
  data      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([storeId])
}

/* =========================================================
 * ✅ เพิ่ม: Admin Models
 * ========================================================= */

model AuditLog {
  id          String   @id @default(cuid())

  actorUserId Int?
  actor       User?    @relation("AuditLogsActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  action      String
  targetType  String?
  targetId    String?

  ip          String?
  userAgent   String?
  meta        Json?
  createdAt   DateTime @default(now())

  @@index([actorUserId])
  @@index([createdAt])
}

model SecurityEvent {
  id        String   @id @default(cuid())
  type      String

  email     String?
  userId    Int?
  user      User?    @relation("SecurityEventsUser", fields: [userId], references: [id], onDelete: SetNull)

  ip        String?
  userAgent String?
  meta      Json?
  createdAt DateTime @default(now())

  @@index([type])
  @@index([createdAt])
}

enum ComplaintStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  REJECTED
}

model Complaint {
  id        String          @id @default(cuid())

  userId    Int?
  user      User?           @relation("ComplaintsUser", fields: [userId], references: [id], onDelete: SetNull)

  category  String?
  subject   String
  message   String
  status    ComplaintStatus @default(OPEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}
